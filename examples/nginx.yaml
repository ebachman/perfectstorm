- group:
    name: nginx
    query:
      type: swarm-task
      image:
        $regex: '^library/nginx:'

- application:
    name: nginx
    components:
      - nginx

- procedure:
    name: nginx-create
    type: swarm
    content: |
      - service create
          --name nginx
          --mode global
          --publish 80:80
          --health-cmd 'nginx -t'
          --health-interval 5s
          nginx

- procedure:
    name: nginx-destroy
    type: swarm
    content: |
      % for service in groups.get('nginx').members.filter({'type': 'swarm-service', 'parent': target.id})
        - service rm {{ service.snapshot.ID }}
      % endfor
